# 交易查询

交易查询，或称链码查询。本章节重点分析msp身份认证过程，及查询数据过程。

流程：
1. 客户端，发起链码查询 (client -> peer)
2. peer查出本地数据，响应返回结果给客户端 (peer -> client)


## 1. client发起链码查询
对应命令入口
```bash
peer chaincode query ...
```

1. 程序入口的main函数
(`src/github.com/hyperledger/fabric/peer/main.go:29`)

1. 几层调用后，调用到函数func queryCmd(...)
(`src/github.com/hyperledger/fabric/peer/chaincode/query.go:19`)

1. 在其中，通过函数func InitCmdFactory(...)
初始化对象ChaincodeCmdFactory, 其中包含三个客户端对象pb.EndorserClient, api.PeerDeliverClient, common.BroadcastClient
(`src/github.com/hyperledger/fabric/peer/chaincode/query.go:56`)。

    * 其中，通过函数func common.GetDefaultSignerFnc()获取msp.SigningIdentity签名身份对象
    (`src/github.com/hyperledger/fabric/peer/chaincode/common.go:375`)，
    其实现函数为func GetDefaultSigner()
    (`src/github.com/hyperledger/fabric/peer/common/common.go:159`)。
        
        * 其内部通过func (msp.MSP) GetDefaultSigningIdentity()获取签名身份对象
        (`src/github.com/hyperledger/fabric/peer/common/common.go:160`)。
        * 首先通过函数func loadLocaMSP()做如下事情
        (`src/github.com/hyperledger/fabric/msp/mgmt/mgmt.go:146`)
            1. 获取配置参数如msp类型，其默认为bccspMSP，封装进对象NewOpts中
            具体类型可参考`src/github.com/hyperledger/fabric/msp/msp.go:201`；
            1. 通过函数func New(opts NewOpts)，生成msp实例
            (`src/github.com/hyperledger/fabric/msp/factory.go:56`)
            其中，实际生成逻辑为函数func newBccspMsp(...)，其主要配置了MSP实例继承bccsp.BCCSP的函数，
            如启动、验证身份方法等。
            (`src/github.com/hyperledger/fabric/msp/mspimpl.go:103`)。
            1. bccsp中封装了加密算法, 文件keystore处理等，(#TODO: 值得进一步分析）
            1. 返回msp接口对象，即bccspmsp实例
        
        * 随后，通过bccspmsp获取签名身份对象，
        使用对象方法func (msp *bccspmsp) GetDefaultSigningIdentity()，
        将bccspmsp.signer返回，其实例为??
        (`src/github.com/hyperledger/fabric/msp/mspimpl.go:255`)，
        
        

1. 进一步调用函数func ChaincodeInvokeOrQuery(...)做查询，与invoke基本一致
(`src/github.com/hyperledger/fabric/peer/chaincode/common.go:102`)。

    * 在其中，